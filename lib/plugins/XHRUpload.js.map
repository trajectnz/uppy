{"version":3,"sources":["../../src/plugins/XHRUpload.js"],"names":["Plugin","require","cuid","Translator","UppySocket","emitSocketProgress","getSocketHost","settle","limitPromises","buildResponseError","xhr","error","Error","data","request","module","exports","uppy","opts","type","id","title","defaultLocale","strings","timedOut","defaultOptions","formData","fieldName","method","metaFields","responseUrlFieldName","bundle","headers","locale","timeout","limit","getResponseData","responseContent","responseObject","response","JSON","parse","err","log","getResponseError","translator","i18n","translate","bind","handleUpload","limitUploads","fn","getOptions","file","state","xhrUpload","createProgressTimeout","timeoutHandler","self","onTimedOut","seconds","Math","ceil","aliveTimer","progress","done","setTimeout","clearTimeout","createFormDataUpload","formPost","FormData","Array","isArray","Object","keys","meta","forEach","item","append","createBareUpload","upload","current","total","resolve","reject","timer","abort","emit","XMLHttpRequest","addEventListener","ev","loaded","lengthComputable","uploader","bytesUploaded","bytesTotal","target","status","body","responseText","uploadURL","setFileState","name","open","toUpperCase","endpoint","header","setRequestHeader","send","on","fileID","uploadRemote","fields","fetch","remote","url","credentials","stringify","size","fieldname","metadata","then","res","statusText","json","token","host","socket","progressData","resp","close","errData","uploadBundle","files","i","emitError","uploadFiles","actions","map","parseInt","length","isRemote","promises","action","limitedAction","fileIDs","getFile","install","addUploader","uninstall","removeUploader"],"mappings":"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","file":"XHRUpload.js","sourcesContent":["const Plugin = require('../core/Plugin')\nconst cuid = require('cuid')\nconst Translator = require('../core/Translator')\nconst UppySocket = require('../core/UppySocket')\nconst {\n  emitSocketProgress,\n  getSocketHost,\n  settle,\n  limitPromises\n} = require('../core/Utils')\n\nfunction buildResponseError (xhr, error) {\n  // No error message\n  if (!error) error = new Error('Upload error')\n  // Got an error message string\n  if (typeof error === 'string') error = new Error(error)\n  // Got something else\n  if (!(error instanceof Error)) {\n    error = Object.assign(new Error('Upload error'), { data: error })\n  }\n\n  error.request = xhr\n  return error\n}\n\nmodule.exports = class XHRUpload extends Plugin {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = 'XHRUpload'\n    this.title = 'XHRUpload'\n\n    const defaultLocale = {\n      strings: {\n        timedOut: 'Upload stalled for %{seconds} seconds, aborting.'\n      }\n    }\n\n    // Default options\n    const defaultOptions = {\n      formData: true,\n      fieldName: 'files[]',\n      method: 'post',\n      metaFields: null,\n      responseUrlFieldName: 'url',\n      bundle: false,\n      headers: {},\n      locale: defaultLocale,\n      timeout: 30 * 1000,\n      limit: 0,\n      /**\n       * @typedef respObj\n       * @property {string} responseText\n       * @property {number} status\n       * @property {string} statusText\n       * @property {Object.<string, string>} headers\n       *\n       * @param {string} responseContent the response body\n       * @param {XMLHttpRequest | respObj} responseObject the response object\n       */\n      getResponseData (responseContent, responseObject) {\n        let response = {}\n        try {\n          response = JSON.parse(responseContent)\n        } catch (err) {\n          this.uppy.log(err, 'error')\n        }\n\n        return response\n      },\n      /**\n       *\n       * @param {string} responseContent the response body\n       * @param {XMLHttpRequest | respObj} responseObject the response object\n       */\n      getResponseError (responseContent, responseObject) {\n        return new Error('Upload error')\n      }\n    }\n\n    // Merge default options with the ones set by user\n    this.opts = Object.assign({}, defaultOptions, opts)\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\n\n    // i18n\n    this.translator = new Translator({ locale: this.locale })\n    this.i18n = this.translator.translate.bind(this.translator)\n\n    this.handleUpload = this.handleUpload.bind(this)\n\n    // Simultaneous upload limiting is shared across all uploads with this plugin.\n    if (typeof this.opts.limit === 'number' && this.opts.limit !== 0) {\n      this.limitUploads = limitPromises(this.opts.limit)\n    } else {\n      this.limitUploads = (fn) => fn\n    }\n\n    if (this.opts.bundle && !this.opts.formData) {\n      throw new Error('`opts.formData` must be true when `opts.bundle` is enabled.')\n    }\n  }\n\n  getOptions (file) {\n    const opts = Object.assign({},\n      this.opts,\n      this.uppy.state.xhrUpload || {},\n      file.xhrUpload || {}\n    )\n    opts.headers = {}\n    Object.assign(opts.headers, this.opts.headers)\n    if (this.uppy.state.xhrUpload) {\n      Object.assign(opts.headers, this.uppy.state.xhrUpload.headers)\n    }\n    if (file.xhrUpload) {\n      Object.assign(opts.headers, file.xhrUpload.headers)\n    }\n\n    return opts\n  }\n\n  // Helper to abort upload requests if there has not been any progress for `timeout` ms.\n  // Create an instance using `timer = createProgressTimeout(10000, onTimeout)`\n  // Call `timer.progress()` to signal that there has been progress of any kind.\n  // Call `timer.done()` when the upload has completed.\n  createProgressTimeout (timeout, timeoutHandler) {\n    const uppy = this.uppy\n    const self = this\n    function onTimedOut () {\n      uppy.log(`[XHRUpload] timed out`)\n      const error = new Error(self.i18n('timedOut', { seconds: Math.ceil(timeout / 1000) }))\n      timeoutHandler(error)\n    }\n\n    let aliveTimer = null\n    function progress () {\n      if (timeout > 0) {\n        done()\n        aliveTimer = setTimeout(onTimedOut, timeout)\n      }\n    }\n\n    function done () {\n      if (aliveTimer) {\n        clearTimeout(aliveTimer)\n        aliveTimer = null\n      }\n    }\n\n    return {\n      progress,\n      done\n    }\n  }\n\n  createFormDataUpload (file, opts) {\n    const formPost = new FormData()\n\n    const metaFields = Array.isArray(opts.metaFields)\n      ? opts.metaFields\n      // Send along all fields by default.\n      : Object.keys(file.meta)\n    metaFields.forEach((item) => {\n      formPost.append(item, file.meta[item])\n    })\n\n    formPost.append(opts.fieldName, file.data)\n\n    return formPost\n  }\n\n  createBareUpload (file, opts) {\n    return file.data\n  }\n\n  upload (file, current, total) {\n    const opts = this.getOptions(file)\n\n    this.uppy.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      const data = opts.formData\n        ? this.createFormDataUpload(file, opts)\n        : this.createBareUpload(file, opts)\n\n      const timer = this.createProgressTimeout(opts.timeout, (error) => {\n        xhr.abort()\n        this.uppy.emit('upload-error', file, error)\n        reject(error)\n      })\n\n      const xhr = new XMLHttpRequest()\n      const id = cuid()\n\n      xhr.upload.addEventListener('loadstart', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} started`)\n        // Begin checking for timeouts when loading starts.\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} progress: ${ev.loaded} / ${ev.total}`)\n        timer.progress()\n\n        if (ev.lengthComputable) {\n          this.uppy.emit('upload-progress', {\n            uploader: this,\n            id: file.id,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total\n          })\n        }\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} finished`)\n        timer.done()\n\n        if (ev.target.status >= 200 && ev.target.status < 300) {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const response = {\n            status: ev.target.status,\n            body,\n            uploadURL\n          }\n\n          this.uppy.setFileState(file.id, { response })\n\n          this.uppy.emit('upload-success', file, body, uploadURL)\n\n          if (uploadURL) {\n            this.uppy.log(`Download ${file.name} from ${file.uploadURL}`)\n          }\n\n          return resolve(file)\n        } else {\n          const body = opts.getResponseData(xhr)\n          const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n\n          const response = {\n            status: ev.target.status,\n            body\n          }\n\n          this.uppy.setFileState(file.id, { response })\n\n          this.uppy.emit('upload-error', file, error)\n          return reject(error)\n        }\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} errored`)\n        timer.done()\n\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n        this.uppy.emit('upload-error', file, error)\n        return reject(error)\n      })\n\n      xhr.open(opts.method.toUpperCase(), opts.endpoint, true)\n\n      Object.keys(opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, opts.headers[header])\n      })\n\n      xhr.send(data)\n\n      this.uppy.on('upload-cancel', (fileID) => {\n        if (fileID === file.id) {\n          xhr.abort()\n        }\n      })\n\n      this.uppy.on('cancel-all', () => {\n        // const files = this.uppy.getState().files\n        // if (!files[file.id]) return\n        xhr.abort()\n      })\n    })\n  }\n\n  uploadRemote (file, current, total) {\n    const opts = this.getOptions(file)\n    return new Promise((resolve, reject) => {\n      const fields = {}\n      const metaFields = Array.isArray(opts.metaFields)\n        ? opts.metaFields\n        // Send along all fields by default.\n        : Object.keys(file.meta)\n\n      metaFields.forEach((name) => {\n        fields[name] = file.meta[name]\n      })\n\n      fetch(file.remote.url, {\n        method: 'post',\n        credentials: 'include',\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(Object.assign({}, file.remote.body, {\n          endpoint: opts.endpoint,\n          size: file.data.size,\n          fieldname: opts.fieldName,\n          metadata: fields,\n          headers: opts.headers\n        }))\n      })\n      .then((res) => {\n        if (res.status < 200 && res.status > 300) {\n          return reject(res.statusText)\n        }\n\n        res.json().then((data) => {\n          const token = data.token\n          const host = getSocketHost(file.remote.host)\n          const socket = new UppySocket({ target: `${host}/api/${token}` })\n\n          socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n          socket.on('success', (data) => {\n            const resp = opts.getResponseData(data.response.responseText, data.response)\n            const uploadURL = resp[opts.responseUrlFieldName]\n            this.uppy.emit('upload-success', file, resp, uploadURL)\n            socket.close()\n            return resolve()\n          })\n\n          socket.on('error', (errData) => {\n            const resp = errData.response\n            const error = resp ? opts.getResponseError(resp.responseText, resp) : new Error(errData.error)\n            this.uppy.emit('upload-error', file, error)\n            reject(new Error(errData.error))\n          })\n        })\n      })\n    })\n  }\n\n  uploadBundle (files) {\n    return new Promise((resolve, reject) => {\n      const endpoint = this.opts.endpoint\n      const method = this.opts.method\n\n      const formData = new FormData()\n      files.forEach((file, i) => {\n        const opts = this.getOptions(file)\n        formData.append(opts.fieldName, file.data)\n      })\n\n      const xhr = new XMLHttpRequest()\n\n      const timer = this.createProgressTimeout(this.opts.timeout, (error) => {\n        xhr.abort()\n        emitError(error)\n        reject(error)\n      })\n\n      const emitError = (error) => {\n        files.forEach((file) => {\n          this.uppy.emit('upload-error', file, error)\n        })\n      }\n\n      xhr.upload.addEventListener('loadstart', (ev) => {\n        this.uppy.log('[XHRUpload] started uploading bundle')\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        timer.progress()\n\n        if (!ev.lengthComputable) return\n\n        files.forEach((file) => {\n          this.uppy.emit('upload-progress', {\n            uploader: this,\n            id: file.id,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total\n          })\n        })\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        timer.done()\n\n        if (ev.target.status >= 200 && ev.target.status < 300) {\n          const resp = this.opts.getResponseData(xhr.responseText, xhr)\n          files.forEach((file) => {\n            this.uppy.emit('upload-success', file, resp)\n          })\n          return resolve()\n        }\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        error.request = xhr\n        emitError(error)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        timer.done()\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        emitError(error)\n        return reject(error)\n      })\n\n      this.uppy.on('cancel-all', () => {\n        xhr.abort()\n      })\n\n      xhr.open(method.toUpperCase(), endpoint, true)\n\n      Object.keys(this.opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, this.opts.headers[header])\n      })\n\n      xhr.send(formData)\n\n      files.forEach((file) => {\n        this.uppy.emit('upload-started', file.id)\n      })\n    })\n  }\n\n  uploadFiles (files) {\n    const actions = files.map((file, i) => {\n      const current = parseInt(i, 10) + 1\n      const total = files.length\n\n      if (file.error) {\n        return () => Promise.reject(new Error(file.error))\n      } else if (file.isRemote) {\n        // We emit upload-started here, so that it's also emitted for files\n        // that have to wait due to the `limit` option.\n        this.uppy.emit('upload-started', file.id)\n        return this.uploadRemote.bind(this, file, current, total)\n      } else {\n        this.uppy.emit('upload-started', file.id)\n        return this.upload.bind(this, file, current, total)\n      }\n    })\n\n    const promises = actions.map((action) => {\n      const limitedAction = this.limitUploads(action)\n      return limitedAction()\n    })\n\n    return settle(promises)\n  }\n\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.uppy.log('[XHRUpload] No files to upload!')\n      return Promise.resolve()\n    }\n\n    this.uppy.log('[XHRUpload] Uploading...')\n    const files = fileIDs.map((fileID) => this.uppy.getFile(fileID))\n\n    if (this.opts.bundle) {\n      return this.uploadBundle(files)\n    }\n\n    return this.uploadFiles(files).then(() => null)\n  }\n\n  install () {\n    this.uppy.addUploader(this.handleUpload)\n  }\n\n  uninstall () {\n    this.uppy.removeUploader(this.handleUpload)\n  }\n}\n"]}